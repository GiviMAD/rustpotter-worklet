function t(t,e,r,s){return new(r||(r=Promise))((function(o,n){function i(t){try{c(s.next(t))}catch(t){n(t)}}function a(t){try{c(s.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,a)}c((s=s.apply(t,e||[])).next())}))}let e;!function(t){function e(){}function r(){}e.prototype.encode=function(t){for(var e=[],r=t.length,s=0;s<r;){var o=t.codePointAt(s),n=0,i=0;for(o<=127?(n=0,i=0):o<=2047?(n=6,i=192):o<=65535?(n=12,i=224):o<=2097151&&(n=18,i=240),e.push(i|o>>n),n-=6;n>=0;)e.push(128|o>>n&63),n-=6;s+=o>=65536?2:1}return e},globalThis.TextEncoder=e,t.TextEncoder||(t.TextEncoder=e),r.prototype.decode=function(t){if(!t)return"";for(var e="",r=0;r<t.length;){var s=t[r],o=0,n=0;if(s<=127?(o=0,n=255&s):s<=223?(o=1,n=31&s):s<=239?(o=2,n=15&s):s<=244&&(o=3,n=7&s),t.length-r-o>0)for(var i=0;i<o;)n=n<<6|63&(s=t[r+i+1]),i+=1;else n=65533,o=t.length-r;e+=String.fromCodePoint(n),r+=o+1}return e},globalThis.TextDecoder=r,t.TextDecoder||(t.TextDecoder=r)}(typeof globalThis==""+void 0?typeof global==""+void 0?typeof self==""+void 0?this:self:global:globalThis);const r=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});r.decode();let s=null;function o(){return null!==s&&0!==s.byteLength||(s=new Uint8Array(e.memory.buffer)),s}function n(t,e){return r.decode(o().subarray(t,t+e))}const i=new Array(128).fill(void 0);i.push(void 0,null,!0,!1);let a=i.length;let c=0;function l(t,e){const r=e(1*t.length);return o().set(t,r/1),c=t.length,r}let d=null;function p(){return null!==d&&0!==d.byteLength||(d=new Int32Array(e.memory.buffer)),d}function u(t){const e=function(t){return i[t]}(t);return function(t){t<132||(i[t]=a,a=t)}(t),e}let h=null;function _(t,r){const s=r(4*t.length);return(null!==h&&0!==h.byteLength||(h=new Uint32Array(e.memory.buffer)),h).set(t,s/4),c=t.length,s}let f=null;function g(t,r){const s=r(2*t.length);return(null!==f&&0!==f.byteLength||(f=new Uint16Array(e.memory.buffer)),f).set(t,s/2),c=t.length,s}let w=null;function m(){return null!==w&&0!==w.byteLength||(w=new Float32Array(e.memory.buffer)),w}const b=new TextEncoder("utf-8"),y="function"==typeof b.encodeInto?function(t,e){return b.encodeInto(t,e)}:function(t,e){const r=b.encode(t);return e.set(r),{read:t.length,written:r.length}};function S(t){return null==t}const v=Object.freeze({int:0,0:"int",float:1,1:"float"});class k{static __wrap(t){const e=Object.create(k.prototype);return e.ptr=t,e}__destroy_into_raw(){const t=this.ptr;return this.ptr=0,t}free(){const t=this.__destroy_into_raw();e.__wbg_rustpotter_free(t)}addWakeword(t){try{const s=e.__wbindgen_add_to_stack_pointer(-16),o=l(t,e.__wbindgen_malloc),n=c;e.rustpotter_addWakeword(s,this.ptr,o,n);var r=p()[s/4+0];if(p()[s/4+1])throw u(r)}finally{e.__wbindgen_add_to_stack_pointer(16)}}processInt32(t){const r=_(t,e.__wbindgen_malloc),s=c,o=e.rustpotter_processInt32(this.ptr,r,s);return 0===o?void 0:M.__wrap(o)}processInt16(t){const r=g(t,e.__wbindgen_malloc),s=c,o=e.rustpotter_processInt16(this.ptr,r,s);return 0===o?void 0:M.__wrap(o)}processFloat32(t){const r=function(t,e){const r=e(4*t.length);return m().set(t,r/4),c=t.length,r}(t,e.__wbindgen_malloc),s=c,o=e.rustpotter_processFloat32(this.ptr,r,s);return 0===o?void 0:M.__wrap(o)}processBuffer(t){const r=l(t,e.__wbindgen_malloc),s=c,o=e.rustpotter_processBuffer(this.ptr,r,s);return 0===o?void 0:M.__wrap(o)}getFrameSize(){return e.rustpotter_getFrameSize(this.ptr)>>>0}getByteFrameSize(){return e.rustpotter_getByteFrameSize(this.ptr)>>>0}}class B{static __wrap(t){const e=Object.create(B.prototype);return e.ptr=t,e}__destroy_into_raw(){const t=this.ptr;return this.ptr=0,t}free(){const t=this.__destroy_into_raw();e.__wbg_rustpotterbuilder_free(t)}static new(){const t=e.rustpotterbuilder_new();return B.__wrap(t)}setThreshold(t){e.rustpotterbuilder_setThreshold(this.ptr,t)}setAveragedThreshold(t){e.rustpotterbuilder_setAveragedThreshold(this.ptr,t)}setMinScores(t){e.rustpotterbuilder_setMinScores(this.ptr,t)}setScoreMode(t){e.rustpotterbuilder_setScoreMode(this.ptr,t)}setGainNormalizerEnabled(t){e.rustpotterbuilder_setGainNormalizerEnabled(this.ptr,t)}setGainRef(t){e.rustpotterbuilder_setGainRef(this.ptr,!S(t),S(t)?0:t)}setMinGain(t){e.rustpotterbuilder_setMinGain(this.ptr,t)}setMaxGain(t){e.rustpotterbuilder_setMaxGain(this.ptr,t)}setBandPassEnabled(t){e.rustpotterbuilder_setBandPassEnabled(this.ptr,t)}setBandPassLowCutoff(t){e.rustpotterbuilder_setBandPassLowCutoff(this.ptr,t)}setBandPassHighCutoff(t){e.rustpotterbuilder_setBandPassHighCutoff(this.ptr,t)}setBitsPerSample(t){e.rustpotterbuilder_setBitsPerSample(this.ptr,t)}setSampleRate(t){e.rustpotterbuilder_setSampleRate(this.ptr,t)}setSampleFormat(t){e.rustpotterbuilder_setSampleFormat(this.ptr,t)}setChannels(t){e.rustpotterbuilder_setChannels(this.ptr,t)}setComparatorBandSize(t){e.rustpotterbuilder_setComparatorBandSize(this.ptr,t)}setComparatorRef(t){e.rustpotterbuilder_setComparatorRef(this.ptr,t)}build(){try{const s=e.__wbindgen_add_to_stack_pointer(-16);e.rustpotterbuilder_build(s,this.ptr);var t=p()[s/4+0],r=p()[s/4+1];if(p()[s/4+2])throw u(r);return k.__wrap(t)}finally{e.__wbindgen_add_to_stack_pointer(16)}}}class M{static __wrap(t){const e=Object.create(M.prototype);return e.ptr=t,e}__destroy_into_raw(){const t=this.ptr;return this.ptr=0,t}free(){const t=this.__destroy_into_raw();e.__wbg_rustpotterdetection_free(t)}getName(){try{const s=e.__wbindgen_add_to_stack_pointer(-16);e.rustpotterdetection_getName(s,this.ptr);var t=p()[s/4+0],r=p()[s/4+1];return n(t,r)}finally{e.__wbindgen_add_to_stack_pointer(16),e.__wbindgen_free(t,r)}}getScore(){return e.rustpotterdetection_getScore(this.ptr)}getAvgScore(){return e.rustpotterdetection_getAvgScore(this.ptr)}getScoreNames(){try{const s=e.__wbindgen_add_to_stack_pointer(-16);e.rustpotterdetection_getScoreNames(s,this.ptr);var t=p()[s/4+0],r=p()[s/4+1];return n(t,r)}finally{e.__wbindgen_add_to_stack_pointer(16),e.__wbindgen_free(t,r)}}getScoreByName(t){try{const n=e.__wbindgen_add_to_stack_pointer(-16),i=function(t,e,r){if(void 0===r){const r=b.encode(t),s=e(r.length);return o().subarray(s,s+r.length).set(r),c=r.length,s}let s=t.length,n=e(s);const i=o();let a=0;for(;a<s;a++){const e=t.charCodeAt(a);if(e>127)break;i[n+a]=e}if(a!==s){0!==a&&(t=t.slice(a)),n=r(n,s,s=a+3*t.length);const e=o().subarray(n+a,n+s);a+=y(t,e).written}return c=a,n}(t,e.__wbindgen_malloc,e.__wbindgen_realloc),a=c;e.rustpotterdetection_getScoreByName(n,this.ptr,i,a);var r=p()[n/4+0],s=m()[n/4+1];return 0===r?void 0:s}finally{e.__wbindgen_add_to_stack_pointer(16)}}getScores(){try{const i=e.__wbindgen_add_to_stack_pointer(-16);e.rustpotterdetection_getScores(i,this.ptr);var t=p()[i/4+0],r=p()[i/4+1],s=(o=t,n=r,m().subarray(o/4,o/4+n)).slice();return e.__wbindgen_free(t,4*r),s}finally{e.__wbindgen_add_to_stack_pointer(16)}var o,n}getCounter(){return e.rustpotterdetection_getCounter(this.ptr)>>>0}getGain(){return e.rustpotterdetection_getGain(this.ptr)}}function A(){const t={wbg:{}};return t.wbg.__wbindgen_string_new=function(t,e){return function(t){a===i.length&&i.push(i.length+1);const e=a;return a=i[e],i[e]=t,e}(n(t,e))},t.wbg.__wbindgen_throw=function(t,e){throw new Error(n(t,e))},t}async function P(t){void 0===t&&(t=new URL("rustpotter_wasm_bg.wasm",import.meta.url));const r=A();("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t));const{instance:o,module:n}=await async function(t,e){if("function"==typeof Response&&t instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(t,e)}catch(e){if("application/wasm"==t.headers.get("Content-Type"))throw e;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}const r=await t.arrayBuffer();return await WebAssembly.instantiate(r,e)}{const r=await WebAssembly.instantiate(t,e);return r instanceof WebAssembly.Instance?{instance:r,module:t}:r}}(await t,r);return function(t,r){return e=t.exports,P.__wbindgen_wasm_module=r,w=null,d=null,f=null,h=null,s=null,e}(o,n)}class R{constructor(e,r,s){if(this.config=r,this.onSpot=s,!this.config.sampleRate)throw new Error("sampleRate value is required to record. NOTE: Audio is not resampled!");this.samplesOffset=0,this.wasmLoadedPromise=(()=>t(this,void 0,void 0,(function*(){yield P(WebAssembly.compile(e));const t=B.new();t.setSampleRate(this.config.sampleRate),t.setSampleFormat(v.float),t.setBitsPerSample(32),t.setChannels(1),t.setAveragedThreshold(this.config.averagedThreshold),t.setThreshold(this.config.threshold),t.setComparatorRef(this.config.comparatorRef),t.setComparatorBandSize(this.config.comparatorBandSize),t.setMinScores(this.config.minScores),t.setScoreMode(this.config.scoreMode),t.setGainNormalizerEnabled(this.config.gainNormalizerEnabled),t.setMinGain(this.config.minGain),t.setMaxGain(this.config.maxGain),null!=this.config.gainRef&&t.setGainRef(this.config.gainRef),t.setBandPassEnabled(this.config.bandPassEnabled),t.setBandPassLowCutoff(this.config.bandPassLowCutoff),t.setBandPassHighCutoff(this.config.bandPassHighCutoff),this.rustpotter=t.build(),this.rustpotterFrameSize=this.rustpotter.getFrameSize(),this.samples=new Float32Array(this.rustpotterFrameSize),t.free()})))()}waitReady(){return this.wasmLoadedPromise}addWakeword(t){this.rustpotter.addWakeword(t)}process(t){const e=t[0],r=this.samplesOffset+e.length;if(r<=this.rustpotterFrameSize)this.samples.set(e,this.samplesOffset),r==this.rustpotterFrameSize-1?(this.handleDetection(this.rustpotter.processFloat32(this.samples)),this.samplesOffset=0):this.samplesOffset=r;else{var s=this.rustpotterFrameSize-this.samplesOffset;this.samples.set(e.subarray(0,s),this.samplesOffset),this.handleDetection(this.rustpotter.processFloat32(this.samples));var o=e.subarray(s);o.length>=e.length?(this.samplesOffset=0,this.process([o])):(this.samples.set(o,0),this.samplesOffset=e.length-s)}}handleDetection(t){if(t){const e=t.getScoreNames().split("||"),r=t.getScores().reduce(((t,r,s)=>{const o=e[s];return o&&(t[o]=r),t}),{});this.onSpot({name:t.getName(),avgScore:t.getAvgScore(),score:t.getScore(),counter:t.getCounter(),gain:t.getGain(),scores:r}),t.free()}}close(){this.rustpotter.free()}}if("function"==typeof registerProcessor){class t extends AudioWorkletProcessor{constructor(){super(),this.continueProcess=!0,this.port.onmessage=({data:t})=>{switch(t.command){case"close":this.continueProcess=!1;break;case"done":this.continueProcess=!1,this.recorder&&(this.recorder.close(),this.recorder=null),this.port.postMessage({type:"done"});break;case"init":const e=t.wasmBytes;delete t.wasmBytes,this.recorder=new R(e,t,(t=>this.port.postMessage({type:"detection",detection:t}))),this.recorder.waitReady().then((()=>{this.port.postMessage({type:"rustpotter-ready"})})).catch((t=>{console.error(t),this.port.postMessage({type:"rustpotter-error"})}));break;case"wakeword":const r=new Uint8Array(t.wakewordBytes);this.recorder||this.port.postMessage({type:"wakeword-error"});try{this.recorder.addWakeword(r),this.port.postMessage({type:"wakeword-loaded"})}catch(t){console.error(t),this.port.postMessage({type:"wakeword-error"})}break;default:console.error("Unknown command")}}}process(t){return this.recorder&&t[0]&&t[0].length&&t[0][0]&&t[0][0].length&&this.recorder.process(t[0]),this.continueProcess}}registerProcessor("rustpotter-worklet",t)}else{let t;onmessage=({data:e})=>{switch(e.command){case"process":t&&t.process(e.buffers);break;case"done":if(t){const e=t;t=null,e.close(),postMessage({type:"done"})}break;case"close":close();break;case"init":const r=e.wasmBytes;delete e.wasmBytes,t=new R(r,e,(t=>postMessage({type:"detection",detection:t}))),t.waitReady().then((()=>{postMessage({type:"rustpotter-ready"})})).catch((t=>{console.error(t),postMessage({type:"rustpotter-error"})}));break;case"wakeword":const s=new Uint8Array(e.wakewordBytes);t||postMessage({type:"wakeword-error"});try{t.addWakeword(s),postMessage({type:"wakeword-loaded"})}catch(t){console.error(t),postMessage({type:"wakeword-error"})}}}}
