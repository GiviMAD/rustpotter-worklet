function e(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{a(n.next(e))}catch(e){o(e)}}function _(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,_)}a((n=n.apply(e,t||[])).next())}))}let t;!function(e){function t(){}function r(){}t.prototype.encode=function(e){for(var t=[],r=e.length,n=0;n<r;){var s=e.codePointAt(n),o=0,i=0;for(s<=127?(o=0,i=0):s<=2047?(o=6,i=192):s<=65535?(o=12,i=224):s<=2097151&&(o=18,i=240),t.push(i|s>>o),o-=6;o>=0;)t.push(128|s>>o&63),o-=6;n+=s>=65536?2:1}return t},globalThis.TextEncoder=t,e.TextEncoder||(e.TextEncoder=t),r.prototype.decode=function(e){if(!e)return"";for(var t="",r=0;r<e.length;){var n=e[r],s=0,o=0;if(n<=127?(s=0,o=255&n):n<=223?(s=1,o=31&n):n<=239?(s=2,o=15&n):n<=244&&(s=3,o=7&n),e.length-r-s>0)for(var i=0;i<s;)o=o<<6|63&(n=e[r+i+1]),i+=1;else o=65533,s=e.length-r;t+=String.fromCodePoint(o),r+=s+1}return t},globalThis.TextDecoder=r,e.TextDecoder||(e.TextDecoder=r)}(typeof globalThis==""+void 0?typeof global==""+void 0?typeof self==""+void 0?this:self:global:globalThis);const r="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&r.decode();let n=null;function s(){return null!==n&&0!==n.byteLength||(n=new Uint8Array(t.memory.buffer)),n}function o(e,t){return e>>>=0,r.decode(s().subarray(e,e+t))}const i=new Array(128).fill(void 0);i.push(void 0,null,!0,!1);let _=i.length;function a(e){_===i.length&&i.push(i.length+1);const t=_;return _=i[t],i[t]=e,t}function c(e){return i[e]}function u(e){const t=c(e);return function(e){e<132||(i[e]=_,_=e)}(e),t}let d=0;function l(e,t){const r=t(1*e.length,1)>>>0;return s().set(e,r/1),d=e.length,r}let g=null;function f(){return null!==g&&0!==g.byteLength||(g=new Int32Array(t.memory.buffer)),g}let p=null;function w(e,r){const n=r(4*e.length,4)>>>0;return(null!==p&&0!==p.byteLength||(p=new Uint32Array(t.memory.buffer)),p).set(e,n/4),d=e.length,n}let b=null;function h(e,r){const n=r(2*e.length,2)>>>0;return(null!==b&&0!==b.byteLength||(b=new Uint16Array(t.memory.buffer)),b).set(e,n/2),d=e.length,n}let y=null;function m(){return null!==y&&0!==y.byteLength||(y=new Float32Array(t.memory.buffer)),y}const S="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},v="function"==typeof S.encodeInto?function(e,t){return S.encodeInto(e,t)}:function(e,t){const r=S.encode(e);return t.set(r),{read:e.length,written:r.length}};function k(e){return null==e}function M(e,r){try{return e.apply(this,r)}catch(e){t.__wbindgen_exn_store(a(e))}}const A=Object.freeze({i8:0,0:"i8",i16:1,1:"i16",i32:2,2:"i32",f32:3,3:"f32"});class P{static __wrap(e){e>>>=0;const t=Object.create(P.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();t.__wbg_rustpotter_free(e)}addWakeword(e){try{const n=t.__wbindgen_add_to_stack_pointer(-16),s=l(e,t.__wbindgen_malloc),o=d;t.rustpotter_addWakeword(n,this.__wbg_ptr,s,o);var r=f()[n/4+0];if(f()[n/4+1])throw u(r)}finally{t.__wbindgen_add_to_stack_pointer(16)}}processI32(e){const r=w(e,t.__wbindgen_malloc),n=d,s=t.rustpotter_processI32(this.__wbg_ptr,r,n);return 0===s?void 0:R.__wrap(s)}processI16(e){const r=h(e,t.__wbindgen_malloc),n=d,s=t.rustpotter_processI16(this.__wbg_ptr,r,n);return 0===s?void 0:R.__wrap(s)}processF32(e){const r=function(e,t){const r=t(4*e.length,4)>>>0;return m().set(e,r/4),d=e.length,r}(e,t.__wbindgen_malloc),n=d,s=t.rustpotter_processF32(this.__wbg_ptr,r,n);return 0===s?void 0:R.__wrap(s)}processBytes(e){const r=l(e,t.__wbindgen_malloc),n=d,s=t.rustpotter_processBytes(this.__wbg_ptr,r,n);return 0===s?void 0:R.__wrap(s)}getSamplesPerFrame(){return t.rustpotter_getSamplesPerFrame(this.__wbg_ptr)>>>0}getBytesPerFrame(){return t.rustpotter_getBytesPerFrame(this.__wbg_ptr)>>>0}}class T{static __wrap(e){e>>>=0;const t=Object.create(T.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();t.__wbg_rustpotterbuilder_free(e)}static new(){const e=t.rustpotterbuilder_new();return T.__wrap(e)}setThreshold(e){t.rustpotterbuilder_setThreshold(this.__wbg_ptr,e)}setAveragedThreshold(e){t.rustpotterbuilder_setAveragedThreshold(this.__wbg_ptr,e)}setMinScores(e){t.rustpotterbuilder_setMinScores(this.__wbg_ptr,e)}setVADMode(e){t.rustpotterbuilder_setVADMode(this.__wbg_ptr,k(e)?3:e)}setScoreMode(e){t.rustpotterbuilder_setScoreMode(this.__wbg_ptr,e)}setGainNormalizerEnabled(e){t.rustpotterbuilder_setGainNormalizerEnabled(this.__wbg_ptr,e)}setGainRef(e){t.rustpotterbuilder_setGainRef(this.__wbg_ptr,!k(e),k(e)?0:e)}setMinGain(e){t.rustpotterbuilder_setMinGain(this.__wbg_ptr,e)}setMaxGain(e){t.rustpotterbuilder_setMaxGain(this.__wbg_ptr,e)}setBandPassEnabled(e){t.rustpotterbuilder_setBandPassEnabled(this.__wbg_ptr,e)}setBandPassLowCutoff(e){t.rustpotterbuilder_setBandPassLowCutoff(this.__wbg_ptr,e)}setBandPassHighCutoff(e){t.rustpotterbuilder_setBandPassHighCutoff(this.__wbg_ptr,e)}setSampleRate(e){t.rustpotterbuilder_setSampleRate(this.__wbg_ptr,e)}setSampleFormat(e){t.rustpotterbuilder_setSampleFormat(this.__wbg_ptr,e)}setChannels(e){t.rustpotterbuilder_setChannels(this.__wbg_ptr,e)}setBandSize(e){t.rustpotterbuilder_setBandSize(this.__wbg_ptr,e)}setScoreRef(e){t.rustpotterbuilder_setScoreRef(this.__wbg_ptr,e)}build(){try{const n=t.__wbindgen_add_to_stack_pointer(-16);t.rustpotterbuilder_build(n,this.__wbg_ptr);var e=f()[n/4+0],r=f()[n/4+1];if(f()[n/4+2])throw u(r);return P.__wrap(e)}finally{t.__wbindgen_add_to_stack_pointer(16)}}}class R{static __wrap(e){e>>>=0;const t=Object.create(R.prototype);return t.__wbg_ptr=e,t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,e}free(){const e=this.__destroy_into_raw();t.__wbg_rustpotterdetection_free(e)}getName(){let e,r;try{const i=t.__wbindgen_add_to_stack_pointer(-16);t.rustpotterdetection_getName(i,this.__wbg_ptr);var n=f()[i/4+0],s=f()[i/4+1];return e=n,r=s,o(n,s)}finally{t.__wbindgen_add_to_stack_pointer(16),t.__wbindgen_free(e,r,1)}}getScore(){return t.rustpotterdetection_getScore(this.__wbg_ptr)}getAvgScore(){return t.rustpotterdetection_getAvgScore(this.__wbg_ptr)}getScoreNames(){let e,r;try{const i=t.__wbindgen_add_to_stack_pointer(-16);t.rustpotterdetection_getScoreNames(i,this.__wbg_ptr);var n=f()[i/4+0],s=f()[i/4+1];return e=n,r=s,o(n,s)}finally{t.__wbindgen_add_to_stack_pointer(16),t.__wbindgen_free(e,r,1)}}getScoreByName(e){try{const o=t.__wbindgen_add_to_stack_pointer(-16),i=function(e,t,r){if(void 0===r){const r=S.encode(e),n=t(r.length,1)>>>0;return s().subarray(n,n+r.length).set(r),d=r.length,n}let n=e.length,o=t(n,1)>>>0;const i=s();let _=0;for(;_<n;_++){const t=e.charCodeAt(_);if(t>127)break;i[o+_]=t}if(_!==n){0!==_&&(e=e.slice(_)),o=r(o,n,n=_+3*e.length,1)>>>0;const t=s().subarray(o+_,o+n);_+=v(e,t).written}return d=_,o}(e,t.__wbindgen_malloc,t.__wbindgen_realloc),_=d;t.rustpotterdetection_getScoreByName(o,this.__wbg_ptr,i,_);var r=f()[o/4+0],n=m()[o/4+1];return 0===r?void 0:n}finally{t.__wbindgen_add_to_stack_pointer(16)}}getScores(){try{const i=t.__wbindgen_add_to_stack_pointer(-16);t.rustpotterdetection_getScores(i,this.__wbg_ptr);var e=f()[i/4+0],r=f()[i/4+1],n=(s=e,o=r,s>>>=0,m().subarray(s/4,s/4+o)).slice();return t.__wbindgen_free(e,4*r),n}finally{t.__wbindgen_add_to_stack_pointer(16)}var s,o}getCounter(){return t.rustpotterdetection_getCounter(this.__wbg_ptr)>>>0}getGain(){return t.rustpotterdetection_getGain(this.__wbg_ptr)}}function B(){const e={wbg:{}};return e.wbg.__wbindgen_string_new=function(e,t){return a(o(e,t))},e.wbg.__wbg_getRandomValues_37fa2ca9e4e07fab=function(){return M((function(e,t){c(e).getRandomValues(c(t))}),arguments)},e.wbg.__wbindgen_object_drop_ref=function(e){u(e)},e.wbg.__wbg_randomFillSync_dc1e9a60c158336d=function(){return M((function(e,t){c(e).randomFillSync(u(t))}),arguments)},e.wbg.__wbg_crypto_c48a774b022d20ac=function(e){return a(c(e).crypto)},e.wbg.__wbindgen_is_object=function(e){const t=c(e);return"object"==typeof t&&null!==t},e.wbg.__wbg_process_298734cf255a885d=function(e){return a(c(e).process)},e.wbg.__wbg_versions_e2e78e134e3e5d01=function(e){return a(c(e).versions)},e.wbg.__wbg_node_1cd7a5d853dbea79=function(e){return a(c(e).node)},e.wbg.__wbindgen_is_string=function(e){return"string"==typeof c(e)},e.wbg.__wbg_msCrypto_bcb970640f50a1e8=function(e){return a(c(e).msCrypto)},e.wbg.__wbg_require_8f08ceecec0f4fee=function(){return M((function(){return a(module.require)}),arguments)},e.wbg.__wbindgen_is_function=function(e){return"function"==typeof c(e)},e.wbg.__wbg_newnoargs_581967eacc0e2604=function(e,t){return a(new Function(o(e,t)))},e.wbg.__wbg_call_cb65541d95d71282=function(){return M((function(e,t){return a(c(e).call(c(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return a(c(e))},e.wbg.__wbg_call_01734de55d61e11d=function(){return M((function(e,t,r){return a(c(e).call(c(t),c(r)))}),arguments)},e.wbg.__wbg_buffer_085ec1f694018c4f=function(e){return a(c(e).buffer)},e.wbg.__wbg_self_1ff1d729e9aae938=function(){return M((function(){return a(self.self)}),arguments)},e.wbg.__wbg_window_5f4faef6c12b79ec=function(){return M((function(){return a(window.window)}),arguments)},e.wbg.__wbg_globalThis_1d39714405582d3c=function(){return M((function(){return a(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_651f05c6a0944d1c=function(){return M((function(){return a(global.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){return void 0===c(e)},e.wbg.__wbg_newwithbyteoffsetandlength_6da8e527659b86aa=function(e,t,r){return a(new Uint8Array(c(e),t>>>0,r>>>0))},e.wbg.__wbg_new_8125e318e6245eed=function(e){return a(new Uint8Array(c(e)))},e.wbg.__wbg_set_5cf90238115182c3=function(e,t,r){c(e).set(c(t),r>>>0)},e.wbg.__wbg_newwithlength_e5d69174d6984cd7=function(e){return a(new Uint8Array(e>>>0))},e.wbg.__wbg_subarray_13db269f57aa838d=function(e,t,r){return a(c(e).subarray(t>>>0,r>>>0))},e.wbg.__wbindgen_throw=function(e,t){throw new Error(o(e,t))},e.wbg.__wbindgen_memory=function(){return a(t.memory)},e}async function x(e){if(void 0!==t)return t;void 0===e&&(e=new URL("rustpotter_wasm_bg.wasm",import.meta.url));const r=B();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:s,module:o}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const r=await e.arrayBuffer();return await WebAssembly.instantiate(r,t)}{const r=await WebAssembly.instantiate(e,t);return r instanceof WebAssembly.Instance?{instance:r,module:e}:r}}(await e,r);return function(e,r){return t=e.exports,x.__wbindgen_wasm_module=r,y=null,g=null,b=null,p=null,n=null,t}(s,o)}class E{constructor(t,r,n){if(this.config=r,this.onSpot=n,!this.config.sampleRate)throw new Error("sampleRate value is required to record. NOTE: Audio is not resampled!");this.samplesOffset=0,this.wasmLoadedPromise=(()=>e(this,void 0,void 0,(function*(){yield x(WebAssembly.compile(t));const e=T.new();e.setSampleRate(this.config.sampleRate),e.setSampleFormat(A.f32),e.setChannels(1),e.setAveragedThreshold(this.config.averagedThreshold),e.setThreshold(this.config.threshold),e.setScoreRef(this.config.scoreRef),e.setBandSize(this.config.bandSize),e.setMinScores(this.config.minScores),e.setScoreMode(this.config.scoreMode),e.setVADMode(this.config.vadMode),e.setGainNormalizerEnabled(this.config.gainNormalizerEnabled),e.setMinGain(this.config.minGain),e.setMaxGain(this.config.maxGain),null!=this.config.gainRef&&e.setGainRef(this.config.gainRef),e.setBandPassEnabled(this.config.bandPassEnabled),e.setBandPassLowCutoff(this.config.bandPassLowCutoff),e.setBandPassHighCutoff(this.config.bandPassHighCutoff),this.rustpotter=e.build(),e.free(),this.rustpotterInputSampleNumber=this.rustpotter.getSamplesPerFrame(),this.samples=new Float32Array(this.rustpotterInputSampleNumber)})))()}waitReady(){return this.wasmLoadedPromise}addWakeword(e){this.rustpotter.addWakeword(e)}process(e){const t=e[0],r=this.rustpotterInputSampleNumber-this.samplesOffset;if(t.length>=r){this.samples.set(t.subarray(0,r),this.samplesOffset),this.handleDetection(this.rustpotter.processF32(this.samples));const e=t.subarray(r);e.length>=this.rustpotterInputSampleNumber?(this.samplesOffset=0,this.process([e])):e.length>0?(this.samplesOffset=e.length,this.samples.set(e,0)):this.samplesOffset=0}else this.samples.set(t,this.samplesOffset),this.samplesOffset+=t.length}handleDetection(e){if(e){const t=e.getScoreNames().split("||"),r=e.getScores().reduce(((e,r,n)=>{const s=t[n];return s&&(e[s]=r),e}),{});this.onSpot({name:e.getName(),avgScore:e.getAvgScore(),score:e.getScore(),counter:e.getCounter(),gain:e.getGain(),scores:r}),e.free()}}close(){this.rustpotter.free()}}if("function"==typeof registerProcessor){class e extends AudioWorkletProcessor{constructor(){super(),this.continueProcess=!0,this.port.onmessage=({data:e})=>{switch(e.command){case"close":this.continueProcess=!1;break;case"done":this.continueProcess=!1,this.recorder&&(this.recorder.close(),this.recorder=null),this.port.postMessage({type:"done"});break;case"init":const t=e.wasmBytes;delete e.wasmBytes,this.recorder=new E(t,e,(e=>this.port.postMessage({type:"detection",detection:e}))),this.recorder.waitReady().then((()=>{this.port.postMessage({type:"rustpotter-ready"})})).catch((e=>{console.error(e),this.port.postMessage({type:"rustpotter-error"})}));break;case"wakeword":const r=new Uint8Array(e.wakewordBytes);this.recorder||this.port.postMessage({type:"wakeword-error"});try{this.recorder.addWakeword(r),this.port.postMessage({type:"wakeword-loaded"})}catch(e){console.error(e),this.port.postMessage({type:"wakeword-error"})}break;default:console.error("Unknown command")}}}process(e){return this.recorder&&e[0]&&e[0].length&&e[0][0]&&e[0][0].length&&this.recorder.process(e[0]),this.continueProcess}}registerProcessor("rustpotter-worklet",e)}else{let e;onmessage=({data:t})=>{switch(t.command){case"process":e&&e.process(t.buffers);break;case"done":if(e){const t=e;e=null,t.close(),postMessage({type:"done"})}break;case"close":close();break;case"init":const r=t.wasmBytes;delete t.wasmBytes,e=new E(r,t,(e=>postMessage({type:"detection",detection:e}))),e.waitReady().then((()=>{postMessage({type:"rustpotter-ready"})})).catch((e=>{console.error(e),postMessage({type:"rustpotter-error"})}));break;case"wakeword":const n=new Uint8Array(t.wakewordBytes);e||postMessage({type:"wakeword-error"});try{e.addWakeword(n),postMessage({type:"wakeword-loaded"})}catch(e){console.error(e),postMessage({type:"wakeword-error"})}}}}
