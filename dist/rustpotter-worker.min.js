var t,e;let n;!function(t){t.STARTED="started",t.STOPPED="stopped",t.DETECTION="detection",t.PORT_STARTED="port_started",t.PORT_STOPPED="port_stopped",t.WAKEWORD_ADDED="wakeword_added"}(t||(t={})),function(t){t.START="start",t.STOP="stop",t.WAKEWORD="wakeword",t.PORT="port",t.STOP_PORT="stop_port"}(e||(e={}));const r="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&r.decode();let s=null;function o(){return null!==s&&0!==s.byteLength||(s=new Uint8Array(n.memory.buffer)),s}function _(t,e){return t>>>=0,r.decode(o().subarray(t,t+e))}const i=new Array(128).fill(void 0);i.push(void 0,null,!0,!1);let a=i.length;function c(t){a===i.length&&i.push(i.length+1);const e=a;return a=i[e],i[e]=t,e}function u(t){return i[t]}function d(t){const e=u(t);return function(t){t<132||(i[t]=a,a=t)}(t),e}let l=0;function g(t,e){const n=e(1*t.length,1)>>>0;return o().set(t,n/1),l=t.length,n}let w=null;function b(){return null!==w&&0!==w.byteLength||(w=new Int32Array(n.memory.buffer)),w}let f=null;function p(t,e){const r=e(4*t.length,4)>>>0;return(null!==f&&0!==f.byteLength||(f=new Uint32Array(n.memory.buffer)),f).set(t,r/4),l=t.length,r}let h=null;function m(t,e){const r=e(2*t.length,2)>>>0;return(null!==h&&0!==h.byteLength||(h=new Uint16Array(n.memory.buffer)),h).set(t,r/2),l=t.length,r}let y=null;function S(){return null!==y&&0!==y.byteLength||(y=new Float32Array(n.memory.buffer)),y}const T="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},P="function"==typeof T.encodeInto?function(t,e){return T.encodeInto(t,e)}:function(t,e){const n=T.encode(t);return e.set(n),{read:t.length,written:n.length}};function A(t){return null==t}function R(t,e){try{return t.apply(this,e)}catch(t){n.__wbindgen_exn_store(c(t))}}const v=Object.freeze({i8:0,0:"i8",i16:1,1:"i16",i32:2,2:"i32",f32:3,3:"f32"});class E{static __wrap(t){t>>>=0;const e=Object.create(E.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();n.__wbg_rustpotter_free(t)}addWakeword(t){try{const r=n.__wbindgen_add_to_stack_pointer(-16),s=g(t,n.__wbindgen_malloc),o=l;n.rustpotter_addWakeword(r,this.__wbg_ptr,s,o);var e=b()[r/4+0];if(b()[r/4+1])throw d(e)}finally{n.__wbindgen_add_to_stack_pointer(16)}}processI32(t){const e=p(t,n.__wbindgen_malloc),r=l,s=n.rustpotter_processI32(this.__wbg_ptr,e,r);return 0===s?void 0:O.__wrap(s)}processI16(t){const e=m(t,n.__wbindgen_malloc),r=l,s=n.rustpotter_processI16(this.__wbg_ptr,e,r);return 0===s?void 0:O.__wrap(s)}processF32(t){const e=function(t,e){const n=e(4*t.length,4)>>>0;return S().set(t,n/4),l=t.length,n}(t,n.__wbindgen_malloc),r=l,s=n.rustpotter_processF32(this.__wbg_ptr,e,r);return 0===s?void 0:O.__wrap(s)}processBytes(t){const e=g(t,n.__wbindgen_malloc),r=l,s=n.rustpotter_processBytes(this.__wbg_ptr,e,r);return 0===s?void 0:O.__wrap(s)}getSamplesPerFrame(){return n.rustpotter_getSamplesPerFrame(this.__wbg_ptr)>>>0}getBytesPerFrame(){return n.rustpotter_getBytesPerFrame(this.__wbg_ptr)>>>0}}class D{static __wrap(t){t>>>=0;const e=Object.create(D.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();n.__wbg_rustpotterbuilder_free(t)}static new(){const t=n.rustpotterbuilder_new();return D.__wrap(t)}setThreshold(t){n.rustpotterbuilder_setThreshold(this.__wbg_ptr,t)}setAveragedThreshold(t){n.rustpotterbuilder_setAveragedThreshold(this.__wbg_ptr,t)}setMinScores(t){n.rustpotterbuilder_setMinScores(this.__wbg_ptr,t)}setVADMode(t){n.rustpotterbuilder_setVADMode(this.__wbg_ptr,A(t)?3:t)}setScoreMode(t){n.rustpotterbuilder_setScoreMode(this.__wbg_ptr,t)}setGainNormalizerEnabled(t){n.rustpotterbuilder_setGainNormalizerEnabled(this.__wbg_ptr,t)}setGainRef(t){n.rustpotterbuilder_setGainRef(this.__wbg_ptr,!A(t),A(t)?0:t)}setMinGain(t){n.rustpotterbuilder_setMinGain(this.__wbg_ptr,t)}setMaxGain(t){n.rustpotterbuilder_setMaxGain(this.__wbg_ptr,t)}setBandPassEnabled(t){n.rustpotterbuilder_setBandPassEnabled(this.__wbg_ptr,t)}setBandPassLowCutoff(t){n.rustpotterbuilder_setBandPassLowCutoff(this.__wbg_ptr,t)}setBandPassHighCutoff(t){n.rustpotterbuilder_setBandPassHighCutoff(this.__wbg_ptr,t)}setSampleRate(t){n.rustpotterbuilder_setSampleRate(this.__wbg_ptr,t)}setSampleFormat(t){n.rustpotterbuilder_setSampleFormat(this.__wbg_ptr,t)}setChannels(t){n.rustpotterbuilder_setChannels(this.__wbg_ptr,t)}setBandSize(t){n.rustpotterbuilder_setBandSize(this.__wbg_ptr,t)}setScoreRef(t){n.rustpotterbuilder_setScoreRef(this.__wbg_ptr,t)}build(){try{const r=n.__wbindgen_add_to_stack_pointer(-16);n.rustpotterbuilder_build(r,this.__wbg_ptr);var t=b()[r/4+0],e=b()[r/4+1];if(b()[r/4+2])throw d(e);return E.__wrap(t)}finally{n.__wbindgen_add_to_stack_pointer(16)}}}class O{static __wrap(t){t>>>=0;const e=Object.create(O.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();n.__wbg_rustpotterdetection_free(t)}getName(){let t,e;try{const o=n.__wbindgen_add_to_stack_pointer(-16);n.rustpotterdetection_getName(o,this.__wbg_ptr);var r=b()[o/4+0],s=b()[o/4+1];return t=r,e=s,_(r,s)}finally{n.__wbindgen_add_to_stack_pointer(16),n.__wbindgen_free(t,e,1)}}getScore(){return n.rustpotterdetection_getScore(this.__wbg_ptr)}getAvgScore(){return n.rustpotterdetection_getAvgScore(this.__wbg_ptr)}getScoreNames(){let t,e;try{const o=n.__wbindgen_add_to_stack_pointer(-16);n.rustpotterdetection_getScoreNames(o,this.__wbg_ptr);var r=b()[o/4+0],s=b()[o/4+1];return t=r,e=s,_(r,s)}finally{n.__wbindgen_add_to_stack_pointer(16),n.__wbindgen_free(t,e,1)}}getScoreByName(t){try{const s=n.__wbindgen_add_to_stack_pointer(-16),_=function(t,e,n){if(void 0===n){const n=T.encode(t),r=e(n.length,1)>>>0;return o().subarray(r,r+n.length).set(n),l=n.length,r}let r=t.length,s=e(r,1)>>>0;const _=o();let i=0;for(;i<r;i++){const e=t.charCodeAt(i);if(e>127)break;_[s+i]=e}if(i!==r){0!==i&&(t=t.slice(i)),s=n(s,r,r=i+3*t.length,1)>>>0;const e=o().subarray(s+i,s+r);i+=P(t,e).written}return l=i,s}(t,n.__wbindgen_malloc,n.__wbindgen_realloc),i=l;n.rustpotterdetection_getScoreByName(s,this.__wbg_ptr,_,i);var e=b()[s/4+0],r=S()[s/4+1];return 0===e?void 0:r}finally{n.__wbindgen_add_to_stack_pointer(16)}}getScores(){try{const _=n.__wbindgen_add_to_stack_pointer(-16);n.rustpotterdetection_getScores(_,this.__wbg_ptr);var t=b()[_/4+0],e=b()[_/4+1],r=(s=t,o=e,s>>>=0,S().subarray(s/4,s/4+o)).slice();return n.__wbindgen_free(t,4*e),r}finally{n.__wbindgen_add_to_stack_pointer(16)}var s,o}getCounter(){return n.rustpotterdetection_getCounter(this.__wbg_ptr)>>>0}getGain(){return n.rustpotterdetection_getGain(this.__wbg_ptr)}}function k(){const t={wbg:{}};return t.wbg.__wbindgen_string_new=function(t,e){return c(_(t,e))},t.wbg.__wbg_getRandomValues_37fa2ca9e4e07fab=function(){return R((function(t,e){u(t).getRandomValues(u(e))}),arguments)},t.wbg.__wbindgen_object_drop_ref=function(t){d(t)},t.wbg.__wbg_randomFillSync_dc1e9a60c158336d=function(){return R((function(t,e){u(t).randomFillSync(d(e))}),arguments)},t.wbg.__wbg_crypto_c48a774b022d20ac=function(t){return c(u(t).crypto)},t.wbg.__wbindgen_is_object=function(t){const e=u(t);return"object"==typeof e&&null!==e},t.wbg.__wbg_process_298734cf255a885d=function(t){return c(u(t).process)},t.wbg.__wbg_versions_e2e78e134e3e5d01=function(t){return c(u(t).versions)},t.wbg.__wbg_node_1cd7a5d853dbea79=function(t){return c(u(t).node)},t.wbg.__wbindgen_is_string=function(t){return"string"==typeof u(t)},t.wbg.__wbg_msCrypto_bcb970640f50a1e8=function(t){return c(u(t).msCrypto)},t.wbg.__wbg_require_8f08ceecec0f4fee=function(){return R((function(){return c(module.require)}),arguments)},t.wbg.__wbindgen_is_function=function(t){return"function"==typeof u(t)},t.wbg.__wbg_newnoargs_581967eacc0e2604=function(t,e){return c(new Function(_(t,e)))},t.wbg.__wbg_call_cb65541d95d71282=function(){return R((function(t,e){return c(u(t).call(u(e)))}),arguments)},t.wbg.__wbindgen_object_clone_ref=function(t){return c(u(t))},t.wbg.__wbg_call_01734de55d61e11d=function(){return R((function(t,e,n){return c(u(t).call(u(e),u(n)))}),arguments)},t.wbg.__wbg_buffer_085ec1f694018c4f=function(t){return c(u(t).buffer)},t.wbg.__wbg_self_1ff1d729e9aae938=function(){return R((function(){return c(self.self)}),arguments)},t.wbg.__wbg_window_5f4faef6c12b79ec=function(){return R((function(){return c(window.window)}),arguments)},t.wbg.__wbg_globalThis_1d39714405582d3c=function(){return R((function(){return c(globalThis.globalThis)}),arguments)},t.wbg.__wbg_global_651f05c6a0944d1c=function(){return R((function(){return c(global.global)}),arguments)},t.wbg.__wbindgen_is_undefined=function(t){return void 0===u(t)},t.wbg.__wbg_newwithbyteoffsetandlength_6da8e527659b86aa=function(t,e,n){return c(new Uint8Array(u(t),e>>>0,n>>>0))},t.wbg.__wbg_new_8125e318e6245eed=function(t){return c(new Uint8Array(u(t)))},t.wbg.__wbg_set_5cf90238115182c3=function(t,e,n){u(t).set(u(e),n>>>0)},t.wbg.__wbg_newwithlength_e5d69174d6984cd7=function(t){return c(new Uint8Array(t>>>0))},t.wbg.__wbg_subarray_13db269f57aa838d=function(t,e,n){return c(u(t).subarray(e>>>0,n>>>0))},t.wbg.__wbindgen_throw=function(t,e){throw new Error(_(t,e))},t.wbg.__wbindgen_memory=function(){return c(n.memory)},t}async function M(t){if(void 0!==n)return n;void 0===t&&(t=new URL("rustpotter_wasm_bg.wasm",import.meta.url));const e=k();("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t));const{instance:r,module:o}=await async function(t,e){if("function"==typeof Response&&t instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(t,e)}catch(e){if("application/wasm"==t.headers.get("Content-Type"))throw e;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}(await t,e);return function(t,e){return n=t.exports,M.__wbindgen_wasm_module=e,y=null,w=null,h=null,f=null,s=null,n}(r,o)}var C,W;!function(t){t.STARTED="started",t.STOPPED="stop",t.AUDIO="audio"}(C||(C={})),function(t){t.START="start",t.STOP="stop",t.PROCESS="process"}(W||(W={}));class B{constructor(t,e,n){this.config=e,this.postMessage=n,this.wasmLoadedPromise=(async()=>{await M(WebAssembly.compile(t));const e=D.new();e.setSampleRate(this.config.sampleRate),e.setSampleFormat(v.f32),e.setChannels(1),e.setAveragedThreshold(this.config.averagedThreshold),e.setThreshold(this.config.threshold),e.setScoreRef(this.config.scoreRef),e.setBandSize(this.config.bandSize),e.setMinScores(this.config.minScores),e.setScoreMode(this.config.scoreMode),e.setVADMode(this.config.vadMode),e.setGainNormalizerEnabled(this.config.gainNormalizerEnabled),e.setMinGain(this.config.minGain),e.setMaxGain(this.config.maxGain),null!=this.config.gainRef&&e.setGainRef(this.config.gainRef),e.setBandPassEnabled(this.config.bandPassEnabled),e.setBandPassLowCutoff(this.config.bandPassLowCutoff),e.setBandPassHighCutoff(this.config.bandPassHighCutoff),this.rustpotter=e.build(),e.free()})()}waitReady(){return this.wasmLoadedPromise}getSamplesPerFrame(){return this.rustpotter.getSamplesPerFrame()}addWakeword(t){this.rustpotter.addWakeword(t)}process(t){this.handleDetection(this.rustpotter.processF32(t))}handleCommand(n){var r,s,o;switch(n[0]){case e.STOP_PORT:null===(r=this.workletPort)||void 0===r||r.postMessage([W.STOP,void 0]),null===(s=this.workletPort)||void 0===s||s.close(),this.workletPort=null,this.postMessage([t.PORT_STOPPED,!0]);break;case e.PORT:null===(o=this.workletPort)||void 0===o||o.close(),this.workletPort=n[1];const _=({data:e})=>{switch(e[0]){case C.STARTED:e[1]?(this.workletPort.addEventListener("message",(({data:t})=>{if(t[0]===C.AUDIO)this.process(t[1])})),this.postMessage([t.PORT_STARTED,!0])):this.postMessage([t.PORT_STARTED,!1]);case C.STOPPED:}};this.workletPort.addEventListener("message",_,{once:!0}),this.workletPort.start&&this.workletPort.start(),this.workletPort.postMessage([W.START,this.getSamplesPerFrame()]);break;case e.WAKEWORD:try{this.addWakeword(new Uint8Array(n[1])),this.postMessage([t.WAKEWORD_ADDED,!0])}catch(e){console.error(e),this.postMessage([t.WAKEWORD_ADDED,!1])}break;case e.STOP:this.close(),this.postMessage([t.STOPPED,void 0]);break;default:console.warn("Unsupported command "+n[0])}}handleDetection(e){if(e){const n=e.getScoreNames().split("||"),r=e.getScores().reduce(((t,e,r)=>{const s=n[r];return s&&(t[s]=e),t}),{});this.postMessage([t.DETECTION,{name:e.getName(),avgScore:e.getAvgScore(),score:e.getScore(),counter:e.getCounter(),gain:e.getGain(),scores:r}]),e.free()}}close(){this.rustpotter.free()}}let F,G=null;onmessage=({data:n})=>{if(n[0]===e.START)null!=G&&console.warn("Already started"),null!=F&&console.warn("Already starting"),F=!0,G=new B(n[1].wasmBytes,n[1].config,(t=>postMessage(t))),G.waitReady().then((()=>{postMessage([t.STARTED,!0])})).catch((e=>{console.error(e),postMessage([t.STARTED,!1])})).finally((()=>{F=!1}));else{if(!G)return void console.warn("Rustpotter worker not started");G.handleCommand(n),n[0]===e.STOP&&(G=null,close())}};
