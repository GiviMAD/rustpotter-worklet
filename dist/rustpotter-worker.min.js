var t,e;let r;!function(t){t.STARTED="started",t.STOPPED="stopped",t.DETECTION="detection",t.PORT_STARTED="port_started",t.PORT_STOPPED="port_stopped",t.WAKEWORD_ADDED="wakeword_added",t.WAKEWORD_REMOVED="wakeword_removed",t.WAKEWORDS_REMOVED="wakewords_removed",t.CONFIG_UPDATED="config_updated"}(t||(t={})),function(t){t.START="start",t.STOP="stop",t.ADD_WAKEWORD="add_wakeword",t.REMOVE_WAKEWORD="remove_wakeword",t.REMOVE_WAKEWORDS="remove_wakewords",t.START_PORT="start_port",t.STOP_PORT="stop_port",t.UPDATE_CONFIG="update_config"}(e||(e={}));const n="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&n.decode();let o=null;function s(){return null!==o&&0!==o.byteLength||(o=new Uint8Array(r.memory.buffer)),o}function _(t,e){return t>>>=0,n.decode(s().subarray(t,t+e))}const i=new Array(128).fill(void 0);i.push(void 0,null,!0,!1);let a=i.length;function c(t){a===i.length&&i.push(i.length+1);const e=a;return a=i[e],i[e]=t,e}function u(t){return i[t]}function d(t){const e=u(t);return function(t){t<132||(i[t]=a,a=t)}(t),e}function g(t,e){if(!(t instanceof e))throw new Error(`expected instance of ${e.name}`);return t.ptr}let l=null;function w(){return null!==l&&0!==l.byteLength||(l=new Int32Array(r.memory.buffer)),l}let f=null;let p=0;function b(t,e){const n=e(4*t.length,4)>>>0;return(null!==f&&0!==f.byteLength||(f=new Uint32Array(r.memory.buffer)),f).set(t,n/4),p=t.length,n}let h=null;function m(t,e){const n=e(2*t.length,2)>>>0;return(null!==h&&0!==h.byteLength||(h=new Uint16Array(r.memory.buffer)),h).set(t,n/2),p=t.length,n}let y=null;function E(){return null!==y&&0!==y.byteLength||(y=new Float32Array(r.memory.buffer)),y}function S(t,e){const r=e(1*t.length,1)>>>0;return s().set(t,r/1),p=t.length,r}const T="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},v="function"==typeof T.encodeInto?function(t,e){return T.encodeInto(t,e)}:function(t,e){const r=T.encode(t);return e.set(r),{read:t.length,written:r.length}};function A(t,e,r){if(void 0===r){const r=T.encode(t),n=e(r.length,1)>>>0;return s().subarray(n,n+r.length).set(r),p=r.length,n}let n=t.length,o=e(n,1)>>>0;const _=s();let i=0;for(;i<n;i++){const e=t.charCodeAt(i);if(e>127)break;_[o+i]=e}if(i!==n){0!==i&&(t=t.slice(i)),o=r(o,n,n=i+3*t.length,1)>>>0;const e=s().subarray(o+i,o+n);i+=v(t,e).written}return p=i,o}function k(t){return null==t}function P(t,e){try{return t.apply(this,e)}catch(t){r.__wbindgen_exn_store(c(t))}}const D=Object.freeze({i8:0,0:"i8",i16:1,1:"i16",i32:2,2:"i32",f32:3,3:"f32"});class R{static __wrap(t){t>>>=0;const e=Object.create(R.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_rustpotter_free(t)}static new(t){try{const o=r.__wbindgen_add_to_stack_pointer(-16);g(t,O),r.rustpotter_new(o,t.__wbg_ptr);var e=w()[o/4+0],n=w()[o/4+1];if(w()[o/4+2])throw d(n);return R.__wrap(e)}finally{r.__wbindgen_add_to_stack_pointer(16)}}processI32(t){const e=b(t,r.__wbindgen_malloc),n=p,o=r.rustpotter_processI32(this.__wbg_ptr,e,n);return 0===o?void 0:W.__wrap(o)}processI16(t){const e=m(t,r.__wbindgen_malloc),n=p,o=r.rustpotter_processI16(this.__wbg_ptr,e,n);return 0===o?void 0:W.__wrap(o)}processF32(t){const e=function(t,e){const r=e(4*t.length,4)>>>0;return E().set(t,r/4),p=t.length,r}(t,r.__wbindgen_malloc),n=p,o=r.rustpotter_processF32(this.__wbg_ptr,e,n);return 0===o?void 0:W.__wrap(o)}processBytes(t){const e=S(t,r.__wbindgen_malloc),n=p,o=r.rustpotter_processBytes(this.__wbg_ptr,e,n);return 0===o?void 0:W.__wrap(o)}addWakeword(t,e){try{const o=r.__wbindgen_add_to_stack_pointer(-16),s=A(t,r.__wbindgen_malloc,r.__wbindgen_realloc),_=p,i=S(e,r.__wbindgen_malloc),a=p;r.rustpotter_addWakeword(o,this.__wbg_ptr,s,_,i,a);var n=w()[o/4+0];if(w()[o/4+1])throw d(n)}finally{r.__wbindgen_add_to_stack_pointer(16)}}removeWakeword(t){const e=A(t,r.__wbindgen_malloc,r.__wbindgen_realloc),n=p;return 0!==r.rustpotter_removeWakeword(this.__wbg_ptr,e,n)}removeWakewords(){return 0!==r.rustpotter_removeWakewords(this.__wbg_ptr)}getSamplesPerFrame(){return r.rustpotter_getSamplesPerFrame(this.__wbg_ptr)>>>0}getBytesPerFrame(){return r.rustpotter_getBytesPerFrame(this.__wbg_ptr)>>>0}updateConfig(t){g(t,O),r.rustpotter_updateConfig(this.__wbg_ptr,t.__wbg_ptr)}reset(){r.rustpotter_reset(this.__wbg_ptr)}}class O{static __wrap(t){t>>>=0;const e=Object.create(O.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_rustpotterconfig_free(t)}static new(){const t=r.rustpotterconfig_new();return O.__wrap(t)}setThreshold(t){r.rustpotterconfig_setThreshold(this.__wbg_ptr,t)}setAveragedThreshold(t){r.rustpotterconfig_setAveragedThreshold(this.__wbg_ptr,t)}setMinScores(t){r.rustpotterconfig_setMinScores(this.__wbg_ptr,t)}setVADMode(t){r.rustpotterconfig_setVADMode(this.__wbg_ptr,k(t)?3:t)}setScoreMode(t){r.rustpotterconfig_setScoreMode(this.__wbg_ptr,t)}setBandSize(t){r.rustpotterconfig_setBandSize(this.__wbg_ptr,t)}setScoreRef(t){r.rustpotterconfig_setScoreRef(this.__wbg_ptr,t)}setEager(t){r.rustpotterconfig_setEager(this.__wbg_ptr,t)}setGainNormalizerEnabled(t){r.rustpotterconfig_setGainNormalizerEnabled(this.__wbg_ptr,t)}setGainRef(t){r.rustpotterconfig_setGainRef(this.__wbg_ptr,!k(t),k(t)?0:t)}setMinGain(t){r.rustpotterconfig_setMinGain(this.__wbg_ptr,t)}setMaxGain(t){r.rustpotterconfig_setMaxGain(this.__wbg_ptr,t)}setBandPassEnabled(t){r.rustpotterconfig_setBandPassEnabled(this.__wbg_ptr,t)}setBandPassLowCutoff(t){r.rustpotterconfig_setBandPassLowCutoff(this.__wbg_ptr,t)}setBandPassHighCutoff(t){r.rustpotterconfig_setBandPassHighCutoff(this.__wbg_ptr,t)}setSampleRate(t){r.rustpotterconfig_setSampleRate(this.__wbg_ptr,t)}setSampleFormat(t){r.rustpotterconfig_setSampleFormat(this.__wbg_ptr,t)}setChannels(t){r.rustpotterconfig_setChannels(this.__wbg_ptr,t)}}class W{static __wrap(t){t>>>=0;const e=Object.create(W.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_rustpotterdetection_free(t)}getName(){let t,e;try{const s=r.__wbindgen_add_to_stack_pointer(-16);r.rustpotterdetection_getName(s,this.__wbg_ptr);var n=w()[s/4+0],o=w()[s/4+1];return t=n,e=o,_(n,o)}finally{r.__wbindgen_add_to_stack_pointer(16),r.__wbindgen_free(t,e,1)}}getScore(){return r.rustpotterdetection_getScore(this.__wbg_ptr)}getAvgScore(){return r.rustpotterdetection_getAvgScore(this.__wbg_ptr)}getScoreByName(t){try{const o=r.__wbindgen_add_to_stack_pointer(-16),s=A(t,r.__wbindgen_malloc,r.__wbindgen_realloc),_=p;r.rustpotterdetection_getScoreByName(o,this.__wbg_ptr,s,_);var e=w()[o/4+0],n=E()[o/4+1];return 0===e?void 0:n}finally{r.__wbindgen_add_to_stack_pointer(16)}}getScoreNames(){let t,e;try{const s=r.__wbindgen_add_to_stack_pointer(-16);r.rustpotterdetection_getScoreNames(s,this.__wbg_ptr);var n=w()[s/4+0],o=w()[s/4+1];return t=n,e=o,_(n,o)}finally{r.__wbindgen_add_to_stack_pointer(16),r.__wbindgen_free(t,e,1)}}getScores(){try{const _=r.__wbindgen_add_to_stack_pointer(-16);r.rustpotterdetection_getScores(_,this.__wbg_ptr);var t=w()[_/4+0],e=w()[_/4+1],n=(o=t,s=e,o>>>=0,E().subarray(o/4,o/4+s)).slice();return r.__wbindgen_free(t,4*e),n}finally{r.__wbindgen_add_to_stack_pointer(16)}var o,s}getCounter(){return r.rustpotterdetection_getCounter(this.__wbg_ptr)>>>0}getGain(){return r.rustpotterdetection_getGain(this.__wbg_ptr)}}function M(){const t={wbg:{}};return t.wbg.__wbindgen_string_new=function(t,e){return c(_(t,e))},t.wbg.__wbg_getRandomValues_37fa2ca9e4e07fab=function(){return P((function(t,e){u(t).getRandomValues(u(e))}),arguments)},t.wbg.__wbindgen_object_drop_ref=function(t){d(t)},t.wbg.__wbg_randomFillSync_dc1e9a60c158336d=function(){return P((function(t,e){u(t).randomFillSync(d(e))}),arguments)},t.wbg.__wbg_crypto_c48a774b022d20ac=function(t){return c(u(t).crypto)},t.wbg.__wbindgen_is_object=function(t){const e=u(t);return"object"==typeof e&&null!==e},t.wbg.__wbg_process_298734cf255a885d=function(t){return c(u(t).process)},t.wbg.__wbg_versions_e2e78e134e3e5d01=function(t){return c(u(t).versions)},t.wbg.__wbg_node_1cd7a5d853dbea79=function(t){return c(u(t).node)},t.wbg.__wbindgen_is_string=function(t){return"string"==typeof u(t)},t.wbg.__wbg_msCrypto_bcb970640f50a1e8=function(t){return c(u(t).msCrypto)},t.wbg.__wbg_require_8f08ceecec0f4fee=function(){return P((function(){return c(module.require)}),arguments)},t.wbg.__wbindgen_is_function=function(t){return"function"==typeof u(t)},t.wbg.__wbg_newnoargs_581967eacc0e2604=function(t,e){return c(new Function(_(t,e)))},t.wbg.__wbg_call_cb65541d95d71282=function(){return P((function(t,e){return c(u(t).call(u(e)))}),arguments)},t.wbg.__wbindgen_object_clone_ref=function(t){return c(u(t))},t.wbg.__wbg_call_01734de55d61e11d=function(){return P((function(t,e,r){return c(u(t).call(u(e),u(r)))}),arguments)},t.wbg.__wbg_buffer_085ec1f694018c4f=function(t){return c(u(t).buffer)},t.wbg.__wbg_self_1ff1d729e9aae938=function(){return P((function(){return c(self.self)}),arguments)},t.wbg.__wbg_window_5f4faef6c12b79ec=function(){return P((function(){return c(window.window)}),arguments)},t.wbg.__wbg_globalThis_1d39714405582d3c=function(){return P((function(){return c(globalThis.globalThis)}),arguments)},t.wbg.__wbg_global_651f05c6a0944d1c=function(){return P((function(){return c(global.global)}),arguments)},t.wbg.__wbindgen_is_undefined=function(t){return void 0===u(t)},t.wbg.__wbg_newwithbyteoffsetandlength_6da8e527659b86aa=function(t,e,r){return c(new Uint8Array(u(t),e>>>0,r>>>0))},t.wbg.__wbg_new_8125e318e6245eed=function(t){return c(new Uint8Array(u(t)))},t.wbg.__wbg_set_5cf90238115182c3=function(t,e,r){u(t).set(u(e),r>>>0)},t.wbg.__wbg_newwithlength_e5d69174d6984cd7=function(t){return c(new Uint8Array(t>>>0))},t.wbg.__wbg_subarray_13db269f57aa838d=function(t,e,r){return c(u(t).subarray(e>>>0,r>>>0))},t.wbg.__wbindgen_throw=function(t,e){throw new Error(_(t,e))},t.wbg.__wbindgen_memory=function(){return c(r.memory)},t}function C(t){if(void 0!==r)return r;const e=M();t instanceof WebAssembly.Module||(t=new WebAssembly.Module(t));return function(t,e){return r=t.exports,y=null,l=null,h=null,f=null,o=null,r}(new WebAssembly.Instance(t,e))}var F,G;!function(t){t.STARTED="started",t.STOPPED="stop",t.AUDIO="audio"}(F||(F={})),function(t){t.START="start",t.STOP="stop",t.PROCESS="process"}(G||(G={}));class B{constructor(t,e,r,n){this.postMessage=n,this.workletAudioCallback=({data:t})=>{t[0]==F.AUDIO&&this.process(t[1])},C(e);const o=O.new();o.setSampleRate(t),o.setSampleFormat(D.f32),o.setChannels(1),this.setConfigOptions(o,r),this.rustpotter=R.new(o),o.free()}getSamplesPerFrame(){return this.rustpotter.getSamplesPerFrame()}process(t){var e;this.handleDetection(null===(e=this.rustpotter)||void 0===e?void 0:e.processF32(t))}updateConfig(t){try{const e=O.new();return this.setConfigOptions(e,t),this.rustpotter.updateConfig(e),!0}catch(t){return console.error(t),!1}}handleCommand(r){switch(r[0]){case e.START_PORT:this.startWorkletPort(r[1]).then((e=>this.postMessage([t.PORT_STARTED,e])));break;case e.STOP_PORT:this.postMessage([t.PORT_STOPPED,this.stopWorkletPort()]);break;case e.ADD_WAKEWORD:this.postMessage([t.WAKEWORD_ADDED,this.addWakeword(...r[1])]);break;case e.REMOVE_WAKEWORD:this.postMessage([t.WAKEWORD_REMOVED,this.removeWakeword(r[1])]);break;case e.REMOVE_WAKEWORDS:this.postMessage([t.WAKEWORDS_REMOVED,this.removeWakewords()]);break;case e.UPDATE_CONFIG:this.postMessage([t.CONFIG_UPDATED,this.updateConfig(r[1])]);break;case e.STOP:this.close(),this.postMessage([t.STOPPED,!0]),close();break;default:console.warn("Unsupported command "+r[0])}}close(){this.stopWorkletPort(),this.rustpotter.free()}addWakeword(t,e){try{return this.rustpotter.addWakeword(t,new Uint8Array(e)),!0}catch(t){return console.error(t),!1}}removeWakeword(t){try{return this.rustpotter.removeWakeword(t)}catch(t){return console.error(t),!1}}removeWakewords(){try{return this.rustpotter.removeWakewords()}catch(t){return console.error(t),!1}}stopWorkletPort(){var t,e,r;try{return null===(t=this.workletPort)||void 0===t||t.removeEventListener("message",this.workletAudioCallback),null===(e=this.workletPort)||void 0===e||e.postMessage([G.STOP,void 0]),null===(r=this.workletPort)||void 0===r||r.close(),this.workletPort=void 0,this.rustpotter.reset(),!0}catch(t){return console.error(t),!1}}startWorkletPort(t){return new Promise((e=>{var r,n,o;try{null===(r=this.workletPort)||void 0===r||r.removeEventListener("message",this.workletAudioCallback),null===(n=this.workletPort)||void 0===n||n.close(),this.workletPort=t,t.addEventListener("message",(({data:r})=>{r[0]==F.STARTED&&(r[1]?(t.addEventListener("message",this.workletAudioCallback),e(!0)):e(!1))}),{once:!0}),null===(o=t.start)||void 0===o||o.call(t),t.postMessage([G.START,this.getSamplesPerFrame()])}catch(t){e(!1)}}))}setConfigOptions(t,e){t.setAveragedThreshold(e.averagedThreshold),t.setThreshold(e.threshold),t.setScoreRef(e.scoreRef),t.setBandSize(e.bandSize),t.setMinScores(e.minScores),t.setEager(e.eager),t.setScoreMode(e.scoreMode),t.setVADMode(e.vadMode),t.setGainNormalizerEnabled(e.gainNormalizerEnabled),t.setMinGain(e.minGain),t.setMaxGain(e.maxGain),t.setGainRef(e.gainRef),t.setBandPassEnabled(e.bandPassEnabled),t.setBandPassLowCutoff(e.bandPassLowCutoff),t.setBandPassHighCutoff(e.bandPassHighCutoff)}handleDetection(e){if(e){const r=e.getScoreNames().split("||"),n=e.getScores().reduce(((t,e,n)=>{const o=r[n];return o&&(t[o]=e),t}),{});this.postMessage([t.DETECTION,{name:e.getName(),avgScore:e.getAvgScore(),score:e.getScore(),counter:e.getCounter(),gain:e.getGain(),scores:n}]),e.free()}}}let N,I=null;onmessage=({data:r})=>{if(r[0]===e.START)try{if(null!=I)throw new Error("Already started");if(null!=N)throw new Error("Starting");N=!0,I=new B(r[1].sampleRate,r[1].wasmBytes,r[1].config,(t=>postMessage(t))),postMessage([t.STARTED,!0])}catch(e){console.error(e),postMessage([t.STARTED,!1])}finally{N=!1}else{if(!I)return void console.warn("Rustpotter worker not started");I.handleCommand(r)}};
